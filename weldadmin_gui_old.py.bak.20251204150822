"""weldadmin_gui_fixed.py
Corrected PyQt5 GUI for WeldAdmin Pro.
This version fixes indentation, variable names, and background-thread handling.
Requires: PyQt5, and the helper modules present in the same folder:
 - ocr.py
 - parser_weldadmin.py
 - weldadmin_auto_map.py
 - weldadmin_import_to_db.py
"""

import os
import sys
import concurrent.futures
from typing import Dict, Any

from PyQt5.QtCore import QTimer
from PyQt5.QtWidgets import (
    QApplication,
    QMainWindow,
    QWidget,
    QFileDialog,
    QMessageBox,
    QLabel,
    QLineEdit,
    QPlainTextEdit,
    QPushButton,
    QFormLayout,
    QVBoxLayout,
    QHBoxLayout,
    QTabWidget,
    QSizePolicy,
)

from weldadmin_auto_map import parse_pdf_to_model
from weldadmin_import_to_db import import_pdf_to_db, ensure_tables

# single executor for background tasks
_EXECUTOR = concurrent.futures.ThreadPoolExecutor(max_workers=2)


class WeldAdminGUI(QMainWindow):
    def __init__(self, parent=None) -> None:
        super().__init__(parent)
        self.setWindowTitle("WeldAdmin Pro - OCR Import GUI")
        self.resize(1000, 700)

        self.current_pdf_path: str = ""
        self.current_model: Dict[str, Any] = {"table": None, "record": {}}

        ensure_tables()  # make sure DB schema exists

        self._build_ui()

    # ---------- UI construction ----------

    def _build_ui(self) -> None:
        central = QWidget(self)
        self.setCentralWidget(central)

        main_layout = QVBoxLayout(central)

        # Top: file selection + buttons
        top_layout = QHBoxLayout()
        self.pdf_path_edit = QLineEdit()
        self.pdf_path_edit.setPlaceholderText("Select a PDF (WPS / PQR / WPQ)...")
        browse_btn = QPushButton("Browse PDF...")
        browse_btn.clicked.connect(self.on_browse_clicked)

        self.load_btn = QPushButton("Load from PDF")
        self.load_btn.clicked.connect(self.on_load_clicked)

        self.import_btn = QPushButton("Import to DB")
        self.import_btn.clicked.connect(self.on_import_clicked)

        top_layout.addWidget(self.pdf_path_edit)
        top_layout.addWidget(browse_btn)
        top_layout.addWidget(self.load_btn)
        top_layout.addWidget(self.import_btn)

        main_layout.addLayout(top_layout)

        # Info line
        info_layout = QHBoxLayout()
        self.label_detected = QLabel("Detected: (none)")
        info_layout.addWidget(self.label_detected)
        info_layout.addStretch()
        main_layout.addLayout(info_layout)

        # Tabs container
        self.tabs = QTabWidget()
        self.tabs.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)

        self._setup_wps_tab()
        self._setup_pqr_tab()
        self._setup_wpq_tab()

        main_layout.addWidget(self.tabs)

    def _setup_wps_tab(self) -> None:
        tab = QWidget()
        layout = QFormLayout(tab)

        self.wps_fields: Dict[str, QLineEdit] = {}

        def add_field(key: str, label: str):
            edit = QLineEdit()
            self.wps_fields[key] = edit
            layout.addRow(label + ":", edit)

        add_field("wps_number", "WPS Number")
        add_field("pqr_number", "PQR Number")
        add_field("code_standard", "Code / Standard")
        add_field("construction_code", "Construction Code")
        add_field("thickness_range_text", "Thickness Range (text)")
        add_field("thickness_min_mm", "Thickness Min (mm)")
        add_field("thickness_max_mm", "Thickness Max (mm)")
        add_field("outside_diameter_range_text", "Outside Diameter Range")
        add_field("joint_type", "Joint Type")

        self.tabs.addTab(tab, "WPS")

    def _setup_pqr_tab(self) -> None:
        tab = QWidget()
        layout = QFormLayout(tab)

        self.pqr_fields: Dict[str, Any] = {}

        def add_line(key: str, label: str):
            edit = QLineEdit()
            self.pqr_fields[key] = edit
            layout.addRow(label + ":", edit)

        add_line("pqr_number", "PQR Number")
        add_line("wps_number", "WPS Number")
        add_line("code_standard", "Code / Standard")
        add_line("pqr_date", "PQR Date")
        add_line("wps_date", "WPS Date")
        add_line("process", "Process")
        add_line("position", "Position")
        add_line("joint_type", "Joint Type")

        base_mat_edit = QPlainTextEdit()
        base_mat_edit.setFixedHeight(60)
        self.pqr_fields["base_material_spec"] = base_mat_edit
        layout.addRow("Base Material Spec:", base_mat_edit)

        add_line("base_material_thickness_mm", "Base Material Thickness (mm)")
        add_line("welder_name", "Welder Name")
        add_line("welder_id", "Welder ID")
        add_line("stamp_number", "Stamp Number")
        add_line("test_lab", "Test Lab")
        add_line("test_report_no", "Test Report No.")

        self.tabs.addTab(tab, "PQR")

    def _setup_wpq_tab(self) -> None:
        tab = QWidget()
        layout = QFormLayout(tab)

        self.wpq_fields: Dict[str, Any] = {}

        def add_line(key: str, label: str):
            edit = QLineEdit()
            self.wpq_fields[key] = edit
            layout.addRow(label + ":", edit)

        add_line("certificate_no", "Certificate No.")
        add_line("wpq_record_no", "WPQ Record No.")
        add_line("welder_name", "Welder Name")
        add_line("welder_id", "Welder ID")
        add_line("qualified_to", "Qualified To")
        add_line("stamp_number", "Stamp Number")
        add_line("wps_number", "WPS Number")
        add_line("process", "Process")
        add_line("position", "Position")

        base_mat_edit = QPlainTextEdit()
        base_mat_edit.setFixedHeight(60)
        self.wpq_fields["base_material_spec"] = base_mat_edit
        layout.addRow("Base Material Spec:", base_mat_edit)

        add_line("test_date", "Test Date")
        add_line("date_issued", "Date Issued")

        job_knowledge_edit = QLineEdit()
        self.wpq_fields["job_knowledge"] = job_knowledge_edit
        layout.addRow("Job Knowledge:", job_knowledge_edit)

        self.tabs.addTab(tab, "WPQ")

    def _set_busy(self, busy: bool) -> None:
        self.load_btn.setEnabled(not busy)
        self.import_btn.setEnabled(not busy)

    def _run_in_main_thread(self, fn, *args, **kwargs) -> None:
        QTimer.singleShot(0, lambda: fn(*args, **kwargs))

    # ---------- Events ----------

    def on_browse_clicked(self) -> None:
        path, _ = QFileDialog.getOpenFileName(
            self,
            "Select PDF",
            "",
            "PDF Files (*.pdf);;All Files (*)",
        )
        if path:
            self.pdf_path_edit.setText(path)

    def on_load_clicked(self) -> None:
        path = self.pdf_path_edit.text().strip()
        if not path or not os.path.isfile(path):
            QMessageBox.warning(self, "No file", "Please select a valid PDF.")
            return

        self._set_busy(True)

        future = _EXECUTOR.submit(parse_pdf_to_model, path)
        future.add_done_callback(lambda fut: self._run_in_main_thread(self._on_load_done, fut, path))

    def _on_load_done(self, future, path: str) -> None:
        try:
            model = future.result()
        except Exception as e:
            QMessageBox.critical(self, "Parse Error", str(e))
            self._set_busy(False)
            return

        table = model.get("table")
        record = model.get("record", {})

        if not table:
            QMessageBox.warning(self, "Unknown", "Unknown document type.")
            self._set_busy(False)
            return

        self.label_detected.setText(f"Detected: {table.upper()}")
        self.current_model = model
        self.current_pdf_path = path

        if table == "wps":
            self._populate_wps(record)
            self.tabs.setCurrentIndex(0)
        elif table == "pqr":
            self._populate_pqr(record)
            self.tabs.setCurrentIndex(1)
        elif table == "wpq":
            self._populate_wpq(record)
            self.tabs.setCurrentIndex(2)

        self._set_busy(False)

    def on_import_clicked(self) -> None:
        path = self.pdf_path_edit.text().strip()
        if not path or not os.path.isfile(path):
            QMessageBox.warning(self, "No file", "Please select a valid PDF.")
            return

        self._set_busy(True)

        future = _EXECUTOR.submit(import_pdf_to_db, path)
        future.add_done_callback(lambda fut: self._run_in_main_thread(self._on_import_done, fut, path))

    def _on_import_done(self, future, path: str) -> None:
        try:
            model = future.result()
        except Exception as e:
            QMessageBox.critical(self, "Import Error", str(e))
            self._set_busy(False)
            return

        table = model.get("table")
        if not table:
            QMessageBox.warning(self, "Not Imported", "Unknown document type.")
            self._set_busy(False)
            return

        QMessageBox.information(self, "Success", f"Imported as {table.upper()}.")
        record = model.get("record", {})

        if table == "wps":
            self._populate_wps(record)
        elif table == "pqr":
            self._populate_pqr(record)
        elif table == "wpq":
            self._populate_wpq(record)

        self._set_busy(False)

    # ---------- Populate helpers ----------

    def _populate_wps(self, rec: Dict[str, Any]) -> None:
        for key, widget in self.wps_fields.items():
            widget.setText(rec.get(key, ""))

    def _populate_pqr(self, rec: Dict[str, Any]) -> None:
        for key, widget in self.pqr_fields.items():
            if isinstance(widget, QPlainTextEdit):
                widget.setPlainText(rec.get(key, ""))
            else:
                widget.setText(rec.get(key, ""))

    def _populate_wpq(self, rec: Dict[str, Any]) -> None:
        for key, widget in self.wpq_fields.items():
            if isinstance(widget, QPlainTextEdit):
                widget.setPlainText(rec.get(key, ""))
            else:
                widget.setText(rec.get(key, ""))


def main() -> None:
    app = QApplication(sys.argv)
    window = WeldAdminGUI()
    window.show()
    sys.exit(app.exec_())


if __name__ == "__main__":
    main()
