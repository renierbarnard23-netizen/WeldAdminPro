using System;
using System.Windows;
using Microsoft.EntityFrameworkCore;
using WeldAdminPro.Data;

namespace WeldAdminPro.UI
{
    public partial class App : Application
    {
        protected override void OnStartup(StartupEventArgs e)
        {
            base.OnStartup(e);

            void Log(string msg)
            {
                try
                {
                    Console.WriteLine(msg);
                    var path = System.IO.Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "weldadmin-init.log");
                    System.IO.File.AppendAllText(path, $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] {msg}{Environment.NewLine}");
                }
                catch { }
            }

            Log("WeldAdminPro starting: initializing DB...");

            try
            {
                var options = new DbContextOptionsBuilder<WeldAdminDbContext>()
                    .UseSqlite("Data Source=weldadmin.db")
                    .Options;

                Log("Creating WeldAdminDbContext (using Data Source=weldadmin.db)...");
                using (var db = new WeldAdminDbContext(options))
                {
                    Log("Calling db.Database.Migrate() ...");
                    db.Database.Migrate();
                    Log("db.Database.Migrate() finished successfully.");

                    Log("Calling DataSeeder.Seed(db) ...");
                    try
                    {
                        DataSeeder.Seed(db);
                        Log("DataSeeder.Seed finished.");
                    }
                    catch (Exception seedEx)
                    {
                        Log("DataSeeder.Seed threw: " + seedEx.ToString());
                    }
                }
            }
            catch (Exception ex)
            {
                Log("Failed to initialize database: " + ex.ToString());
                MessageBox.Show($"Failed to initialize database: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
                Shutdown(-1);
                return;
            }

            Log("Database init OK. Launching MainWindow...");

            var main = new MainWindow();
            main.Show();
        }
    }
}
